<!--
 -- @file jtree.js
 --
 -- @brief Basic RestConf Web GUI Demo.
 --
 -- @author Alexandru Ponoviciu <alexandru.panoviciu@civica.co.uk>
 --
 -- @copyright
 -- Copyright (c) 2022 Civica NI Ltd
 --
 -- This source code is licensed under BSD 3-Clause License (the "License").
 -- You may not use this file except in compliance with the License.
 -- You may obtain a copy of the License at
 --
 --     https://opensource.org/licenses/BSD-3-Clause
 -->


<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>RestConf GUI</title>
  <link rel="stylesheet" href="res/jtree.css" />
</head>
<body>

  <div id="top">
    <input type="text"
           value=""
           style="position:fixed; right:15px; z-index:1; 
                  box-shadow:inset 0 0 3px #eee; 
                  width:120px; margin:0; padding:6px 12px; 
                  border-radius:4px; border:1px solid silver; 
                  font-size:.9em;"
           id="waf_q"
           placeholder="Search">
  </div>

  <div id="middle">
    RestConf Operational Datastore
    <div id="restconf" class="jtree__viewer">
      Loading...
    </div>
  </div>

  <div id="bottom"
       style="position:fixed; left:0px; bottom:0px;
              padding: 2px;
              width:100%; height:5em;
              box-sizing:border-box;
              z-index:1;">
    <div style="border-radius:4px; border:1px solid silver; 
                background:white; 
                padding:3px 7px; 
                overflow-y: auto; 
                scrollbar-width: thin;
                height:100%; box-sizing:border-box;">
      <label id="debug" class="console"><!-- <br>foo<br>foo<br>foo<br>foo --></label>
    </div>
  </div>

  
  <script src="res/jquery.js"></script>
  <script src="res/jtree.js"></script>

  
  <script>
    $(function () {
        console.log("start at " + window.location);
        
        function say (x) {
            $('#debug').append(x + '<br>');
        }

        if (window.location.protocol == "file:")
        {
            $('#restconf').html(jtreeViewer(some_json()))
        }
        else
        {
            $.getJSON('/cgi-bin/restconf/data',
                      //'/cgi-bin/restconf',
                      function (data)
                      {
                          say("Loaded /cgi-bin/restconf/data")
                          $('#restconf').html(jtreeViewer(data, false))
	              });
        }


        function reveal (node, yes) {
            if (!node.parentElement)
                return
            
            parent = node.parentElement
            //console.log(node.text + "xx" + parent + "classes " + parent.classList)

            if (parent.classList.contains("jtree__item--collapsible")) {
                toggle = parent.children[0]
                toggle.checked = yes
                //console.log("Reveal " + parent.children[1].innerHTML)
            }
            
            reveal(parent, yes)
        }

        $('#waf_q').keypress(function (event) {
            if (event.key == "Enter")
            {
                //console.log(this)
                if (this.lastResultSet) {
                    console.log("Deselecting last set")
                    this.lastResultSet.each(function (i) {
                        $(this).toggleClass("jtree__highlight")
                        reveal(this, false)
                    })
                }

                let s = $(this).val()

                if (!s) {
                    // match nothing
                    r = RegExp('(?!x)x')
                } else if (s[0] == '/') {
                    // /foo/ => match (unanchored)
                    r = RegExp.apply(null, s.substr(1).split('/'))
                } else if (s.toLowerCase() != s) {
                    // Foo => Foo but not foo, FOO aso
                    r = RegExp(s)
                } else {
                    // foo => foo FOO Foo fOO etc
                    r = RegExp(s, 'i')
                }
                this.lastResultSet = $(".jtree__ckey,.jtree__key,.jtree__value").filter(function() {
                    return r.test($(this).text())
                })
                //console.log("Got " + nodes.length + " nodes")
                this.lastResultSet.each(function (i) {
                    $(this).toggleClass("jtree__highlight")
                    reveal(this, true)
                })
            }
        });
    });
  </script>
</body>
</html>
